<div class="container mt-4">

 
  <div class="d-flex justify-content-end mb-3">
    <button type="button" class="btn btn-primary" [routerLink]="['/create-request']">
      Create Request
    </button>
  </div>

  <div class="table-responsive">
    <table class="table table-bordered table-hover align-middle">

      <thead class="table-light">
        <tr>
          <th>#</th>
          <th>Request No</th>
          <th>Title</th>
          <th>Request Type</th>
          <th>Priority</th>
          <th>Status</th>
          <th>Created By</th>
          <th>Created Date</th>
          <th>Attachments</th>
          <th>Actions</th>
        </tr>
      </thead>

      <tbody>
        <tr *ngFor="let sr of requests; let i = index">

          <td>{{ i + 1 }}</td>
          <td>{{ sr.requestNumber }}</td>
          <td>{{ sr.title }}</td>
          <td>{{ RequestType[sr.requestType] }}</td>

          <td>
            <span class="badge bg-warning text-dark">
              {{ Priority[sr.priority] }}
            </span>
          </td>

          <td>
            <span class="badge bg-info">
              {{ Status[sr.status] }}
            </span>
          </td>

          <td>{{ sr.createdBy }}</td>
          <td>{{ sr.createdDate | date:'short' }}</td>

          <!-- ================= Attachments Column ================= -->
          <td>

            <!-- File Input -->
            <input type="file" class="form-control form-control-sm mb-2" multiple accept=".png,.jpg,.jpeg,.pdf,.txt"
              (change)="onFilesSelected($event, sr.id)" />

            <!-- Preview Selected Files -->
            <div *ngIf="selectedFilesMap[sr.id]?.length" class="border rounded p-2 mb-2">

              <strong>Selected Files</strong>

              <div *ngFor="let file of selectedFilesMap[sr.id]" class="border p-2 mt-2">

                <p class="mb-1"><strong>Name:</strong> {{ file.name }}</p>
                <p class="mb-1">
                  <strong>Size:</strong>
                  {{ file.size / 1024 | number:'1.0-0' }} KB
                </p>
                <p class="mb-1">
                  <strong>Type:</strong> {{ file.type || 'unknown' }}
                </p>

                <!-- Image Preview -->
                <img *ngIf="imagePreviewsMap[sr.id]?.[file.name]" [src]="imagePreviewsMap[sr.id][file.name]" width="150"
                  class="d-block mb-2" />

                <!-- TXT Preview -->
                <pre *ngIf="textPreviewsMap[sr.id]?.[file.name]" class="bg-light p-2"
                  style="max-height:120px; overflow:auto;">
                    {{ textPreviewsMap[sr.id][file.name] }}
                </pre>

                <!-- PDF Info -->
                <p *ngIf="file.type === 'application/pdf'">
                  ðŸ“„ PDF File
                </p>

                <button class="btn btn-sm btn-outline-danger" (click)="removeFile(sr.id, file)">
                  Remove
                </button>
              </div>
            </div>

            <!-- Upload Button -->
            <button class="btn btn-sm btn-outline-primary mb-2" (click)="uploadMultiple(sr.id)"
              [disabled]="!selectedFilesMap[sr.id]?.length">
              Upload
            </button>

            <!-- Show / Hide Attachments -->
            <button class="btn btn-sm btn-outline-secondary mb-2" (click)="toggleAttachments(sr.id)">
              {{ attachmentsVisible[sr.id] ? 'Hide Attachments' : 'Show Attachments' }}
            </button>

            <!-- Uploaded Attachments -->
            <ul *ngIf="attachmentsVisible[sr.id]" class="list-unstyled mt-2">

              <li *ngFor="let a of attachmentsMap[sr.id]" class="mb-1">
                ðŸ“Ž {{ a.fileName }}

                <button class="btn btn-link btn-sm" (click)="previewAttachment(a)">
                  Preview
                </button>

                <button class="btn btn-link btn-sm text-danger" (click)="deleteAttachment(sr.id, a.id)">
                  Delete
                </button>
              </li>
            </ul>

          </td>

          <!--  Actions  -->
          <td>
            <button class="btn btn-sm btn-outline-primary me-1" [routerLink]="['/update-request', sr.id]">
              Edit
            </button>

            <button class="btn btn-sm btn-outline-danger" (click)="deleteRequest(sr.id)">
              Delete
            </button>
          </td>

        </tr>
      </tbody>

    </table>
  </div>
</div>